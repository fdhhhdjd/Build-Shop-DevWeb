"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.deploy = void 0;
const tmp_1 = require("tmp");
const clc = require("cli-color");
const fs = require("fs");
const checkIam_1 = require("./checkIam");
const api_1 = require("../../api");
const utils_1 = require("../../utils");
const gcs = require("../../gcp/storage");
const gcf = require("../../gcp/cloudfunctions");
const gcfv2 = require("../../gcp/cloudfunctionsv2");
const utils = require("../../utils");
const GCP_REGION = api_1.functionsUploadRegion;
tmp_1.setGracefulCleanup();
async function uploadSourceV1(context) {
    const uploadUrl = await gcf.generateUploadUrl(context.projectId, GCP_REGION);
    context.uploadUrl = uploadUrl;
    const uploadOpts = {
        file: context.functionsSourceV1,
        stream: fs.createReadStream(context.functionsSourceV1),
    };
    await gcs.upload(uploadOpts, uploadUrl, {
        "x-goog-content-length-range": "0,104857600",
    });
}
async function uploadSourceV2(context, region) {
    const res = await gcfv2.generateUploadUrl(context.projectId, region);
    const uploadOpts = {
        file: context.functionsSourceV2,
        stream: fs.createReadStream(context.functionsSourceV2),
    };
    await gcs.upload(uploadOpts, res.uploadUrl);
    context.storage = Object.assign(Object.assign({}, context.storage), { [region]: res.storageSource });
}
async function deploy(context, options, payload) {
    if (!options.config.src.functions) {
        return;
    }
    await checkIam_1.checkHttpIam(context, options, payload);
    if (!context.functionsSourceV1 && !context.functionsSourceV2) {
        return;
    }
    try {
        const want = payload.functions.backend;
        const uploads = [];
        if (want.cloudFunctions.some((fn) => fn.platform === "gcfv1")) {
            uploads.push(uploadSourceV1(context));
        }
        if (want.cloudFunctions.some((fn) => fn.platform === "gcfv2")) {
            const functions = payload.functions.backend.cloudFunctions;
            const regions = [];
            for (const func of functions) {
                if (func.platform === "gcfv2" && -1 === regions.indexOf(func.region)) {
                    regions.push(func.region);
                }
            }
            for (const region of regions) {
                uploads.push(uploadSourceV2(context, region));
            }
        }
        await Promise.all(uploads);
        utils.assertDefined(options.config.src.functions.source, "Error: 'functions.source' is not defined");
        utils_1.logSuccess(clc.green.bold("functions:") +
            " " +
            clc.bold(options.config.src.functions.source) +
            " folder uploaded successfully");
    }
    catch (err) {
        utils_1.logWarning(clc.yellow("functions:") + " Upload Error: " + err.message);
        throw err;
    }
}
exports.deploy = deploy;
